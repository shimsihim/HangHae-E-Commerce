# e-Commerce 주문 서비스 개요

## 목차
1. [프로젝트 소개](#프로젝트-소개)
2. [사용 기술 스택](#-사용-기술-스택)
3. [주요 기능 범위](#-주요-기능-범위-scope)
4. [테이블 구조](#-테이블)
5. [주요 기술 챌린지 및 학습 목표](#-주요-기술-챌린지-및-학습-목표)

---

## 프로젝트 소개

본 프로젝트는 **e-Commerce 환경에서 발생하는 기술적 과제를 학습하고 구현**하는 것을 목적으로 합니다.

### 핵심 학습 목표
- **동시성 제어**: 재고 차감, 쿠폰 발급, 포인트 사용 시 발생하는 동시성 이슈 해결
- **비동기 처리**: Kafka를 활용한 이벤트 기반 아키텍처 구현
- **분산 락**: Redis를 활용한 공유 자원 접근 제어
- **캐싱 전략**: Redis 캐시를 통한 성능 최적화
- **데이터 정합성**: 분산 환경에서의 트랜잭션 일관성 보장

> 기술적 학습에 집중하기 위해 기능과 테이블을 간소화하였습니다. 장바구니 기능도 제거하였습니다.


## 🛠 사용 기술 스택

| 영역        | 기술                  |
|-----------|---------------------|
| 언어        | Java                |
| 프레임워크     | Spring Boot         |
| 데이터베이스    | MySQL               |
| ORM       | JPA                 |
| 인메모리 DB   | Redis (캐싱 및 분산 락)   |
| 메시지 큐     | Kafka (비동기 처리)      |

## 🎯 주요 기능 범위 (Scope)
본 프로젝트에서 구현할 핵심 기능 범위는 다음과 같습니다.

- **회원:** 사용자 정보, 사용자 포인트 관리 (포인트 충전 및 사용 로직은 동시성 제어 대상)
- **상품/재고:** 상품 정보 조회. 상품 옵션별 재고 관리 (주문 시 동시성 제어 대상)
- **주문:**  주문 생성. 주문 시 재고 차감 및 포인트 사용/적립 로직 포함
- **쿠폰:** 선착순 쿠폰 발급 및 사용자 쿠폰 관리. (쿠폰 발급 시 동시성 제어 대상)
- **결제:** 주문에 대한 모의 결제 처리 및 결제 완료에 따른 후속 처리


## 📋 테이블

### 테이블 구조 개요

| 도메인   | 테이블명               | 용도                | 동시성 제어 필요                      |
|-------|--------------------|-------------------|-------------------------------|
| 유저    | user_point         | 사용자 및 사용자 포인트     | ✅ (balance - 낙관적 락)          |
| 포인트   | point_history      | 포인트 충전/사용 이력      | X                             |
| 상품    | products           | 상품 기본 정보          | X                             |
| 상품    | product_options    | 상품 옵션 및 재고        | ✅ (quantity - 비관적 락/분산 락)    |
| 상품    | product_statistics | 상품 판매 통계 (인기순 조회) | X                             |
| 쿠폰    | coupons            | 쿠폰 정보 및 발급 정책     | ✅ (issued_quantity - 비관적 락/분산 락) |
| 쿠폰    | user_coupons       | 사용자별 쿠폰 소유 내역     | X                             |
| 주문/결제 | orders             | 주문 정보             | X                             |
| 주문/결제 | order_items        | 주문 상세 (주문 항목)     | X                             |

### 동시성 제어 전략

**낙관적 락 (Optimistic Lock)**
- `user_point.balance`: 포인트 충전/사용 시 버전 관리
- 사용자별로 독립적이며 충돌 가능성이 낮음

**비관적 락 (Pessimistic Lock) 또는 Redis 분산 락**
- `product_options.quantity`: 재고 차감 시 높은 동시성 환경 대응
- `coupons.issued_quantity`: **선착순 쿠폰 발급**


---


## 💪 주요 기술 챌린지 및 학습 목표

### 1. 동시성 및 데이터 일관성 
--  우선적으로 redis 사용제외 필수 하단 명시된 Redis는 단순 설계로 실제 구현은 우선 Redis없이 진행한다.

#### 재고 관리
- **문제**: 동시에 발생하는 다수의 주문에서 같은 상품을 구매할 때 재고 초과 차감 문제
- **해결 방안**:
  - 비관적 락(Pessimistic Lock) 또는 Redis 분산 락 활용
  - 재고 차감 로직의 원자성(Atomicity) 보장
  - 재고 부족 시 주문 실패 처리

#### 쿠폰 발급 (선착순) 🔥
- **문제**:
  - 10,000명이 동시에 100개 쿠폰 요청 시 발급 수량 초과 방지
  - 낙관적 락 사용 시 대부분 실패 → UX 악화
  - 비관적 락 사용 시 대기 시간 증가 → 성능 저하
- **최적 해결 방안: Redis 분산 락 + Lua 스크립트**:
  0. 우선 비관적 락으로 빠르게 구현
  1. Redis에 쿠폰별 발급 가능 수량 저장 (`coupon:{couponId}:remaining`)
  2. Lua 스크립트로 수량 확인 및 차감을 원자적으로 처리
  3. 발급 성공 시 비동기로 DB에 기록 (Kafka)
  4. 1인당 발급 제한도 Redis Set으로 관리
- **장점**:
  - 빠른 응답 속도 (Redis 메모리 연산)
  - 정확한 수량 제어 (원자적 연산)
  - 높은 동시성 처리 가능

#### 포인트 관리
- **문제**: 동시에 발생하는 포인트 충전/사용 요청 시 잔액 불일치
- **해결 방안**:
  - 낙관적 락(Optimistic Lock)을 통한 버전 관리
  - 포인트 이력(point_history) 테이블을 통한 변경 내역 추적

#### 분산 트랜잭션
- **고려사항**: 주문, 재고, 포인트, 쿠폰 등 여러 도메인에 걸친 트랜잭션 처리
- **학습 목표**: Saga Pattern, Two-Phase Commit 등의 분산 트랜잭션 패턴 학습

---

### 2. 비동기 처리 및 이벤트 기반 아키텍처

#### Kafka를 통한 이벤트 처리
- **주문 생성 이벤트**: 주문 생성 시 재고 차감, 통계 업데이트 등의 후속 작업 비동기 처리
- **쿠폰 발급 이벤트**: 대량 쿠폰 발급 요청을 이벤트로 처리하여 시스템 부하 분산
- **결제 완료 이벤트**: 결제 완료 후 알림 발송, 포인트 적립 등의 작업 비동기 처리

#### 이벤트 기반 아키텍처 장점
- 느슨한 결합(Loose Coupling): 각 도메인의 독립성 보장
- 확장성: 컨슈머 추가를 통한 수평 확장
- 장애 격리: 특정 기능의 장애가 전체 시스템에 영향 최소화

---

### 3. 성능 최적화

#### 캐싱 전략
- **상품 정보 캐싱**: 자주 조회되는 상품 정보를 Redis에 캐싱
- **인기 상품 캐싱**: product_statistics 테이블 기반 인기 상품 목록 캐싱
- **사용자 정보 캐싱**: 로그인 후 사용자 정보 캐싱으로 조회 성능 향상
- **캐시 전략**: Cache-Aside, Write-Through 등의 캐시 패턴 적용

#### 쿼리 최적화
- **인덱스 설계**: 자주 사용되는 쿼리에 대한 효율적인 인덱스 설계
- **복합 인덱스**: 사용자별 주문 조회, 쿠폰 조회 등에 복합 인덱스 활용
- **커버링 인덱스**: 조회 성능 향상을 위한 커버링 인덱스 고려

#### 배치 처리
- **통계 데이터 업데이트**: 상품 판매량 통계를 배치로 주기적 업데이트
- **만료 쿠폰 처리**: 만료된 쿠폰 상태를 배치로 정리
- **캐시 웜업**: 시스템 시작 시 자주 사용되는 데이터 사전 캐싱

---

### 4. 확장성 및 안정성

#### 수평 확장
- 애플리케이션 서버의 무상태(Stateless) 설계
- 세션 정보의 Redis 저장을 통한 서버 간 공유

#### 모니터링 및 로깅
- 동시성 이슈 추적을 위한 상세 로깅
- 성능 메트릭 수집 및 모니터링
- 장애 발생 시 신속한 대응을 위한 알림 시스템

